# Библиотека _treport_

## Назначение бибилиотеки

Библиотекат _treport_ предназначена для формирования отчетов, имеющих исключительно табличное представление 
и фиксированное количество колонок. Результат формирования отчета выводится в формате _MS Excel_.

## Использование библиотеки

### Подготовительные мероприятия

Перед использованием библиотеки необходимо создать рабочий каталог, где будут размещаться файлы с SQL-запросами
к базе данных, шаблоны отчетных форм, описание параметров формирования отчетов, описание параметров подключения
к базе данных.

В данном проекте присутствует пример такого каталога- _treport_example_. Внутри данного каталога находятся следующие файлы:

- _run_report.xml_- декларативное описание параметров формирования отчетных форм;
- _run_report.ini_ - ini-файл, в котором прописаны параметры подклбчения к базе данных и путь к файлу _run_report.xml_
- _run_report.py_ - программа на языке программирования _Python_, демонстрирующая использование библиотеки.

Внутри каталога _treport_example_ так же были созданы следующие каталоги:

- _sql_ - каталог для хранения файлов с SQL-запросами, которые формируют контент отчета;
- _templates_ - каталог для хранения файлов шаблонов отчетных форм;
- _out_ - каталог для хранения файлов сформированных отчетов.

Для демонстрации работы бибилиотеки необходимо чтобы был установлен _PostgreSQL_ и создана таблица _documents_.

~~~sql
-- treport.documents definition

-- Drop table

-- DROP TABLE treport.documents;

CREATE TABLE treport.documents (
	id int8 NOT NULL GENERATED ALWAYS AS IDENTITY,
	docnum varchar NOT NULL,
	docdate date NOT NULL,
	docsum numeric NOT NULL,
	docsum2 numeric NOT NULL
);
~~~
Содержимое таблицы представлено в файле [documents.csv](https://github.com/novikov-nsa/treport/blob/master/treport_example/documents.csv). 
Для импорта данных из CSV-файла необходимо выполнить команду

~~~sql
copy treport.documents(docnum, docdate, docsum, docsum2) from '/path/to/documents.csv' delimiter ';' csv header;
~~~

### Подготовка шаблона отчета

Шаблон отчета- это файл в формате __xlsx__. Отчет может состоять из нескольких листов.
Нужно иметь в виду, что данная библиотека позволяет формировать отчетные формы, которые имеют
исключительно табличный вид. Отчет может содержать формулы MS Excel. В этом случае
необходимо в SQL-запросе выводить в данной колонке пустое значение, а 
XML-файле, описывающем свойства отчета, указать номера колонок, которые необходимо
игнорировать при формировании отчета. 

### Подготовка SQL-файла

Для получаения данных из БД необходимо подготовить файл с SQL-запросом.
Для каждого листа отчета необходимо подготовить свой файл с SQL-запросом к БД.
Если требуется формировать отчет по заданным параметрам, то необходимо чтобы
значения этих параметров были переданы в SQL-запрос. Для этого в тексте SQL-запроса
параметры обрамляются двойными фигурными скобками (например ```{{ p_name }}```).

### Подготовка ini-файла

В ini-файле описываются параметры подключение к базе данных и путь к декларативному
описанию свойств отчетов.

~~~ini
[database]
login = sergejnovikov
password =
port = 5432
host = localhost
database = postgres

[report]
params_reports = run_report.xml
~~~

Секция __database__- описываются параметры кодключения к БД.

Параметры:

- __login__ - имя пользователя для подключения к БД;
- __password__ - пароль пользователя для подключения к БД;
- __port__ - порт, по которому происходит подключение к БД;
- __host__ - адрес хоста, на котором размещается СУБД PostgreSQL;
- __database__ - наименование БД.

Секция __report__ - описывает параметры отчетных форм.

В данной секции пока только один параметр- __params_reports__. В данном параметре
указывается путь к файлу, в котором приведено описание свойств отчетных форм.

### Декларативное описание отчета

Отчет состоит из двух основных частей- SQL-запроса к базе данных и шаблона, описывающего внешний вид отчета.

Для того чтобы библиотека понимала какие параметры допустимы для формирования отчета, какой шаблон использовать
для формирования отчета, какой SQL-запрос является источником данных для страницы отчета и т.д. необходимо 
описать характеристики отчетов.

Свойства отчета описываются в файле в формате XML. Правило описания свойства
отчетов приведено в [документации](https://github.com/novikov-nsa/treport/wiki/%D0%94%D0%B5%D0%BA%D0%BB%D0%B0%D1%80%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D0%BE%D0%B5-%D0%BE%D0%BF%D0%B8%D1%81%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BE%D1%82%D1%87%D0%B5%D1%82%D0%B0).

### Формирование отчета

После того как подключение к БД настроено, разработаны SQL-запросы, подготовлен шаблон отчета,
можно приступить к написанию скрипта, который вызовет бибилиотеку и сформирует отчет.

~~~python
from src.treport.report import Report, get_config

if __name__ == '__main__':
    parameters = {'p_start_date': '01.05.2022', 'p_end_date': '31.05.2022'}
    db_url, path_to_params_reports_file = get_config('run_report.ini')
    report = Report('treport_example', path_to_params_reports_file, parameters, db_url)

    if report.xml_validation_result:
        report.contentReport.save(report.outDir + report.report_file_name)
        report.logger.info(f'Файл {report.outDir + report.report_file_name} сохранен')
~~~

```from treport.report import Report, get_config``` - импорт из модуля
__report__ пакета __treport__ класса __Report__ и функции __get_config__.

В переменной ```parameters``` в виде словаря хранятся параметры формирования отчета
и их значения.

```db_url, path_to_params_reports_file = get_config('run_report.ini')``` - 
вызывается функция ```get_config```, аргумент функции- путь к ini-файлу, 
возвращается URL  подклбчения к БД и путь к XML-файлу, описывающему свойства
отчетов.

Далее создается объект ```report``. В коструктор класса передаются код формируемого отчета,
путь к XML-файлу, описывающему свойства отчетов, параметры формирования отчета и URL подключения к БД.

Далее происходит проверка на предмет того соответсвует ли XML-файл XSD-схеме.
Если соответсвует, то после формирования отчета происходит сохранение файла отчета.




